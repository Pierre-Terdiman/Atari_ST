;FILL - Version 7: MOVEs/une routine par Dx et par d‚calage.
;Version 7D=MOVEs+Effacage d‚j… g‚n‚r‚

;92 nops/ligne pleine. 89 sans le DBF. ( sans augmenter la m‚moire
;pour autant!!! )
;450 lignes sans le DBF. ( je le laisse pour tester, c'est + simple )

	CLR.L	-(SP)
	MOVE	#$20,-(SP)
	TRAP	#1
	ADDQ.L	#6,SP
	
	LEA	NEWPILE,A7

	CLR	-(SP)
	PEA	-1.W
	PEA	-1.W
	MOVE	#5,-(SP)
	TRAP	#14
	LEA	12(SP),SP	

	MOVE.L	#FIN,$008.W
	MOVE.L	#FIN,$00C.W
	MOVE.L	#FIN,$010.W
	MOVE.L	#FIN,$014.W

	move.l	#BUFFER,d0
	CLR.B	D0
	move.l	d0,SCREEN1		
	add.l	#32000,d0		
	move.l	d0,SCREEN2
	
	CLR.L	FLAG
	LEA	CODE,A0
	LEA	TABLE,A1
	MOVE.L	A0,(A1)+
	LEA	TABLO,A6
	MOVE	#%1000000000000000,(A6)
	MOVE	#%0100000000000000,D6

ANEW	LEA	TABLO,A6
	LEA	TABLO_COPIE,A5
	REPT	10
	MOVE.L	(A6)+,(A5)+
	ENDR

AGAIN	LEA	TABLO,A6
	MOVEQ	#0,D7
	
VIDE	;MOVE	D0,D4
	MOVE	(A6)+,D0
	BEQ.S	VIDE
	CMPI	#$9999,D0
	BEQ.S	GNR

;	TST.L	FLAG
;	BNE.S	SUIT1
;
;	TST	D7
;	BNE.S	PAS_LE_PREMIER_MOT
;	MOVE	#$3082,(A0)+
;	BRA.S	SUIT1
;PAS_LE_PREMIER_MOT
;	MOVE	#$3142,(A0)+
;	MOVE	D7,(A0)+
;	ADDQ	#8,D7
SUIT1
	CMPI	#$FFFF,D0
	BNE.S	NON_PLEIN

	TST	D7
	BEQ.S	DEBUT_DE_LIGNE
	MOVE	#$3141,(A0)+
	MOVE	D7,(A0)+
	ADDQ	#8,D7
	ADDQ.L	#1,FLAG
	BRA.S	SUIT0
DEBUT_DE_LIGNE	MOVE	#$3081,(A0)+
	ADDQ	#8,D7
	ADDQ.L	#1,FLAG
	BRA.S	SUIT0

NON_PLEIN	TST	D7
	BEQ.S	DEB_LINE

*
	MOVE	#$317C,(A0)+
	MOVE	D0,(A0)+
	MOVE	D7,(A0)+
	ADDQ	#8,D7
	ADDQ.L	#1,FLAG
	BRA.S	SUIT0

DEB_LINE	MOVE	#$30BC,(A0)+
	MOVE	D0,(A0)+
	ADDQ	#8,D7
	ADDQ.L	#1,FLAG

SUIT0	BRA.S	VIDE
FLAG	DC.L	0
GNR	
	CMPI	#160,D7
	BEQ.S	STOP_IT
	MOVE	#$3142,(A0)+
	MOVE	D7,(A0)+
STOP_IT	MOVE	#$4ED7,(A0)+

	MOVE.L	A0,(A1)+
	CLR.L	FLAG
	LEA	TABLO,A6
N	SET	0
	REPT	20
	ROXR	N(A6)
N	SET	N+2
	ENDR

	ADDQ.L	#1,CNT
	CMPI.L	#16,CNT
	BNE	AGAIN
	CLR.L	CNT
	LEA	TABLO,A5
	LEA	TABLO_COPIE,A6
	REPT	10
	MOVE.L	(A6)+,(A5)+
	ENDR
	LEA	TABLO,A6
MODX	EQU	*+2
	LEA	0(A6),A6
	OR	D6,(A6)
	LSR	#1,D6
	BNE	ANEW
	MOVE	#%1000000000000000,D6
	ADDQ	#2,MODX
	CMPI	#40,MODX
	BEQ.S	FINITO
	BRA	ANEW
	
FINITO	NOP
	MOVE	#$4EF9,(A0)+
	MOVE.L	#RETOUR_ULTIME,(A0)

	MOVE.L	#VBL,$70.W
H	BRA.S	H
FIN	MOVE.L	4.W,A0
	JMP	(A0)
VBL	
	SF	$FFFF8240.W
	BRA	T
	MOVE.L	SCREEN2,A6
	moveq	#0,d0
	MOVE	#199,D1
EFF
N	SET	0
	REPT	20
	MOVE	D0,N(A6)
N	SET	N+8
	ENDR
	LEA	160(A6),A6
	DBF	D1,EFF
T
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVEQ	#0,D2
	MOVEQ	#0,D3
	MOVEQ	#0,D4
	MOVEQ	#0,D5
	MOVEQ	#0,D6
	MOVEQ	#0,D7


MOD	EQU	*+2
	MOVE	#318,D0
	MOVE	#319,D1

	MOVE	#201,D2
	MOVE	#1,D3
	SUB	D3,D2
	LEA	TAB,A0
	ADDQ.L	#2,A0
	JSR	DO_TRANS

	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVEQ	#0,D2
	MOVEQ	#0,D3
	MOVEQ	#0,D4
	MOVEQ	#0,D5
	MOVEQ	#0,D6
	MOVEQ	#0,D7

MOD2	EQU	*+2
	MOVE	#200,D0
	MOVE	#1,D1

	MOVE	#201,D2
	MOVE	#1,D3
	SUB	D3,D2
	LEA	TAB,A0
	JSR	DO_TRANS

	MOVE	#$001,$FFFF8240.W

	MOVE.L	SCREEN2,A6	6? 7?
	MOVE.L	#$FFFFFFFF,D1	3?
	MOVEQ	#0,D2

	LEA	TABL,A3	3?
	LEA	TABL2,A2	3?
	LEA	TABLE,A4	3?
	LEA	-160(A6),A6	2

	LEA	TAB,A5
	MOVE.L	A7,SAUVEA7
	LEA	RETOUR,A7
	BRA	ICI
;	MOVE	#200-1,D3	2
	DS.L	256
ICI
RETOUR
	LEA	160(A6),A6	2
	MOVE.L	A6,A0	1
;MOD2	EQU	*+2
;	MOVE	#1*4,D6	2
	MOVE	(A5)+,D6
;MOD	EQU	*+2
;	MOVE	#320*4,D7	2
	MOVE	(A5)+,D7

	SUB	D6,D7	1
	LSL	#4,D7	5-1

	ADD	(A3,D6.W),D7	4

	ADDA	(A2,D6.W),A0	5

	MOVE	D2,-8(A0)

	MOVE.L	(A4,D7.W),A1	5
	JMP	(A1)	2+61
;RETOUR
;	DBF	D3,ICI	3
;total=92 nops
;On peut virer le DBF en mettant RETOUR en ICI...on monte alors …
;450 lignes. Mais on ne sait plus quand arreter!!
;Le pb est r‚solu en tps normal coz on aura MOVE (An)+,Dn pour les
;coords. Il suffit de faire une routine sp‚ciale pour des coords
;sp‚ciales. Ex: DeltaX=321 => dans la table de 320*16, rajouter
;une adresse: l'adresse du retour final...

;MOVE D1,(A0) = 2
;MOVE D1,0(A0) = 3
;1 ligne pleine = un Move sans offset+19 Moves avec offsets + JMP (A5)
;               = 2 + 19*3 + 2 = 61 nops
SAUVEA7	DC.L	0
RETOUR_ULTIME
	MOVE.L	SAUVEA7,A7
	CMPI.B	#$F,$FFFFFC02.W
	BNE.S	NO_T
	MOVE	#$002,$FFFF8240.W
NO_T	NOP

	CMPI.B	#$3B,$FFFFFC02.W
	BNE.S	NO_T2
	ADDQ	#1,MOD
NO_T2	NOP
	CMPI.B	#$3c,$FFFFFC02.W
	BNE.S	NO_T2c
	SUBQ	#1,MOD
NO_T2c	NOP
	CMPI.B	#$3D,$FFFFFC02.W
	BNE.S	NO_T2D
	ADDQ	#1,MOD2
NO_T2D	NOP
	CMPI.B	#$3E,$FFFFFC02.W
	BNE.S	NO_T2E
	SUBQ	#1,MOD2
NO_T2E	NOP

	MOVE.L	SCREEN1,D0
	MOVE.L	SCREEN2,SCREEN1
	MOVE.L	D0,SCREEN2

	move.l	SCREEN1,d0	
	lsr.l	#8,d0		
	move.l	#$ffff8201,a0
	movep	d0,(a0)

	RTE

DO_TRANS
;	MOVE.L	#NB_PASSES,D2	EN 'D2' PASSES
	MOVE.L	D2,D6
	MOVE	D2,MODIF
	MOVE	D2,MODIF_

	LSL.L	#8,D0
	LSL.L	#8,D1
	CMP.L	D0,D1
	BGT.S	ROUTY1
ROUTY2	;D1 PLUS PETIT
	MOVE.L	D0,D2
	SUB.L	D1,D0	D1=AMPLITUDE
	DIVU	D6,D0
	SWAP	D0
	CLR	D0
	SWAP	D0
MODIF_	EQU	*+2
	MOVE	#0,D7
	SUBQ	#1,D7
DO_IT_AGAIN_	SUB.L	D0,D2
	MOVE.L	D2,D3
	LSR.L	#8,D3	CA EN FAIT UN
	ADD	D3,D3
	ADD	D3,D3
	MOVE	D3,(A0)
	BGE.S	GOONN
	CLR	(A0)
GOONN	CMPI	#319*4,(A0)
	BLE.S	GOI
	MOVE	#319*4,(A0)
	
GOI	ADDQ.L	#4,A0
	DBF	D7,DO_IT_AGAIN_
FINI2	RTS
****
	
ROUTY1	;D0 PLUS PETIT
	MOVE.L	D0,D2
	SUB.L	D0,D1	D1=AMPLITUDE
	DIVU	D6,D1
	SWAP	D1
	CLR	D1
	SWAP	D1
MODIF	EQU	*+2
	MOVE	#0,D7
	SUBQ	#1,D7
DO_IT_AGAIN	ADD.L	D1,D2
	MOVE.L	D2,D3
	LSR.L	#8,D3	CA EN FAIT UN
	ADD	D3,D3
	ADD	D3,D3
	MOVE	D3,(A0)
	BGE.S	GOON
	CLR	(A0)
GOON	
	CMPI	#319*4,(A0)
	BLE.S	KK
	MOVE	#319*4,(A0)
KK	ADDQ.L	#4,A0
	DBF	D7,DO_IT_AGAIN
FINITED	RTS


	DATA
TABLE1
N	SET	0
	REPT	20
	DC	%1111111111111111,N
	DC	%0111111111111111,N
	DC	%0011111111111111,N
	DC	%0001111111111111,N
	DC	%0000111111111111,N
	DC	%0000011111111111,N
	DC	%0000001111111111,N
	DC	%0000000111111111,N
	DC	%0000000011111111,N
	DC	%0000000001111111,N
	DC	%0000000000111111,N
	DC	%0000000000011111,N
	DC	%0000000000001111,N
	DC	%0000000000000111,N
	DC	%0000000000000011,N
	DC	%0000000000000001,N
N	SET	N+8
	ENDR

TABLE2
N	SET	0
	REPT	20
;	DC	%0000000000000000,N
	DC	%1000000000000000,N
	DC	%1100000000000000,N
	DC	%1110000000000000,N
	DC	%1111000000000000,N
	DC	%1111100000000000,N
	DC	%1111110000000000,N
	DC	%1111111000000000,N
	DC	%1111111100000000,N
	DC	%1111111110000000,N
	DC	%1111111111000000,N
	DC	%1111111111100000,N
	DC	%1111111111110000,N
	DC	%1111111111111000,N
	DC	%1111111111111100,N
	DC	%1111111111111110,N
	DC	%1111111111111111,N
N	SET	N+8
	ENDR

TABL	
	REPT	20
	DC	4*15,0
	DC	0,0
	DC	4,0
	DC	4*2,0
	DC	4*3,0
	DC	4*4,0
	DC	4*5,0
	DC	4*6,0
	DC	4*7,0
	DC	4*8,0
	DC	4*9,0
	DC	4*10,0
	DC	4*11,0
	DC	4*12,0
	DC	4*13,0
	DC	4*14,0
	ENDR


TABL2
	REPT	17
	DC	0,0
	ENDR

N	SET	8
	REPT	19
	DC	N,0
	DC	N,0
	DC	N,0
	DC	N,0
	DC	N,0
	DC	N,0
	DC	N,0
	DC	N,0
	DC	N,0
	DC	N,0
	DC	N,0
	DC	N,0
	DC	N,0
	DC	N,0
	DC	N,0
	DC	N,0
N	SET	N+8
	ENDR

TAB	DS	200*2
	DC	4,320*4

;TAB
;N	SET	2
;	REPT	199
;	DC	N*4
;N	SET	N+1
;	ENDR
;	DC	320*4

CNT	DC.L	0
	DS.L	256
NEWPILE	DS.L	1
TABLO	DCB	20,0
	DC	$9999
TABLO_COPIE	DCB	20,0
	BSS
CODE	DS.B	263000
TABLE	DS.L	20*16*16
GOGO
SCREEN1	DS.L	1
SCREEN2	DS.L	1

	DS.B	256
BUFFER	DS.B	64000
